#! /bin/sh
version="0.4.2"
trkfile="${TRK_FILE-$HOME/.trkfile}"
trk_workday_hours="${TRK_WORKDAY_HOURS-8}"
editor="${EDITOR-vi}"
tmpdir="$TMPDIR-/tmp"
trk_timer_file="$trkfile.timer"

usage() {
    printf 'Usage [v%s]:
    trk t <description>
        starts a timer for a new entry
        eventually terminates the previously active timer
    trk t
        terminates the current timer
    trk tt [notification_interval_in_minutes, default:5]
        starts a long running process that notifies regurarly if there is an active timer

    trk a <date> <hours> <description>
        adds a new entry to the trk file.
        date is any valid value the "date" command can take, e.g. "-", "today", "yesterday", etc.
        hours spent must be a number and can be decimal: 1, 4.25, 0.5, etc.

    trk r [grep_pattern]
        shows an aggregate of trk records with per-tag totals,
        grepping records with grep_pattern if passed.
        by default it reads the trk file, but it can alternatively take input from stdin

    trk e
        edits the trk file with your $EDITOR
    trk c
        prints the trk file to stdout

    trk h
        shows extended help' "$version"; echo
}
helpmsg() {
    usage; echo
    printf 'trkfile:
    the trk file contains a list of trk records, one per line.
    the trk record format is simply: DAY HOURS DESCRIPTION (separated by exactly 1 blank space)
    where: DAY: YYYY-MM-DD, HOURS: a floating point number, DESCRIPTION: a one-line note with optional tags (see below)
    so, e.g.: "2025-01-23 4.5 #billable #client:companyA #project:super_webapp work on backend feature X"

tags:
    descriptions can contain "tags" in the form of #tag or #tag:value
    (tag and value can contain only letters, numbers, undescores "_" and dashes "-", without blank spaces).
    those tags will result in the reports as additional aggregates or can be used by external integrations.

env vars:
    - TRK_DEBUG: set it to whatever value to show debug informations
    - TRK_FILE: the trk file you are working on [default: $HOME/.trkfile]
    - TRK_WORKDAY_HOURS: workday hours [default: 8]
    - TRK_UNFRIENDLY: prints spent time in hours with 2 decimals, useful for sorting, parsing, etc.
    - TRK_TAGS: trk will prepend the content of this var to the record description,
        useful if, e.g., you are working on a specific client/project all day
'
}
_err() { printf "%s: error: %s\n" "$(basename "$0")" "$1" >&2; exit 1; }
_warn() { printf "%s: warn: %s\n" "$(basename "$0")" "$1" >&2; }
_info() { printf "%s: %s\n" "$(basename "$0")" "$1" >&2; }
_dbg() { [ "$TRK_DEBUG" ] && printf "%s: debug: %s\n" "$(basename "$0")" "$1" >&2; return 0; }
_rand_chars() {
    # $1 = number of chars to receive, $2 = filter for the chars
    LC_ALL=C tr -dc "$2" </dev/urandom | dd ibs=1 obs=1 count="$1" 2>/dev/null
}
_mktemp() {
    tmpdir=/dev/shm
    [ -w /dev/shm ] || tmpdir=${TMPDIR:-/tmp}
    tmpfile=$tmpdir/sec.$(_rand_chars 16 'A-Za-z0-9') || _err "couldn't generate random characters"
    mkdir -p "$(dirname "$tmpfile")" || _err "couldn't create temp dir"
    touch "$tmpfile" || _err "couldn't create temp file"
    printf "%s" "$tmpfile"
}
_today() { date '+%Y-%m-%d'; }
_validate_date() { date -d "$(printf "$1")" >/dev/null 2>&1;}
_validate_hours() { printf "$1" | grep -qE '^[+-]?[0-9]+(\.[0-9]+)?$';}
_is_timer_active() { [ -f "$trk_timer_file" ]; }
_get_friendly_time_from_hours() {
    hours_spent="$1"
    seconds_spent="$(awk "BEGIN { print $hours_spent * 3600 }")"
    seconds_spent="$(printf '%.0f\n' "$seconds_spent")"
    timeline="${seconds_spent}s"
    minutes_spent=$(expr $seconds_spent / 60)
    hours_spent=$(expr $minutes_spent / 60)
    days_spent=$(expr $hours_spent / $trk_workday_hours)
    if [ $hours_spent -ge $trk_workday_hours ]; then
        days_in_hours=$(expr $days_spent \* $trk_workday_hours)
        hours_remainder=$(expr $hours_spent - $days_in_hours)
        hours_in_minutes=$(expr $hours_spent \* 60)
        minutes_remainder=$(expr $minutes_spent - $hours_in_minutes)
        timeline="${days_spent}d"
        test $hours_remainder -gt 0 &&
            timeline="${days_spent}d${hours_remainder}h"
        test $minutes_remainder -gt 0 &&
            timeline="${days_spent}d${minutes_remainder}m"
        test $hours_remainder -gt 0 &&
            test $minutes_remainder -gt 0 &&
            timeline="${days_spent}d${hours_remainder}h${minutes_remainder}m"
    elif [ $minutes_spent -ge 60 ]; then
        hours_in_minutes=$(expr $hours_spent \* 60)
        minutes_remainder=$(expr $minutes_spent - $hours_in_minutes)
        timeline="${hours_spent}h"
        test $minutes_remainder -gt 0 &&
            timeline="${hours_spent}h${minutes_remainder}m"
    elif [ $seconds_spent -ge 60 ]; then
        timeline="${minutes_spent}m"
    fi
    echo "$timeline"
}
edit_trkfile() { $editor "$trkfile"; }
add_record() {
    day="$1"
    hours="$2"
    [ -z "$3" ] && usage && exit 1
    shift; shift
    ! _validate_date "$day" &&
        _err "date [$day] is not a valid date" && exit 1
    day="$(date -d "$day" '+%Y-%m-%d')"
    ! _validate_hours "$hours" &&
        _err "hours spent [$hours] is not a valid number" && exit 1
    echo "$day $hours ${TRK_TAGS}${TRK_TAGS+ }$*" >> "$trkfile"
    _info "record added: $(tail -n1 "$trkfile")"
}
_get_timer_hours() {
    start_ts="$(cat "$trk_timer_file" | cut -d' ' -f1)"
    now_ts="$(date '+%s')"
    diff="$(expr $now_ts - $start_ts)"
    hours="$(awk "BEGIN { print $diff / 3600 }")"
    hours="$(printf '%.2f\n' "$hours")"
    printf '%s' "$hours"
}
start_stop_timer() {
    _is_timer_active
    timer_active=$?
    if [ $timer_active -eq 0 ]; then
        description="$(cat "$trk_timer_file" | cut -d' ' -f2-)"
        [ -z "$description" ] &&
            _warn "this timer has no description, edit it later!" &&
            description="add a description"
        hours="$(_get_timer_hours)"
        if [ "$hours" = "0.00" ]; then _warn "nothing to add, timer lasted less than a minute"
        else add_record "-" "$hours" "$description"; fi
        rm -f "$trk_timer_file"
    fi
    if [ -n "$1" ]; then echo "$(date '+%s') $*" >"$trk_timer_file"; _info "started new timer: $*"
    else [ $timer_active -ne 0 ] && _err "add some description to the timer" && return 1; fi

}
start_stop_timer_notification() {
    interval_in_minutes="${1-5}"
    seconds="$(expr $interval_in_minutes \* 60)"
    trap "notify-send -a trk -u low -t 4000 'trk timer' 'timer notification stopped'" EXIT
    ! command -v notify-send >/dev/null &&
        _err "missing 'notify-send' command, cannot send notifications" &&
        exit 1
    while true; do
        _is_timer_active || { sleep $seconds && continue; }
        report="$(report_timer)"
        elapsed="$(echo "$report" | grep "^timer_elaps" | cut -d' ' -f2)"
        desc="$(echo "$report" | grep "^timer_descr" | cut -d' ' -f2-)"
        notify-send -a trk -u low -t 4000 "trk timer: $elapsed" "$desc"
        sleep $seconds
    done
}
report_timer() {
    ! _is_timer_active && return 0
    start_ts="$(cat "$trk_timer_file" | cut -d' ' -f1)"
    timer_start_date="$(date -d "@$start_ts" '+%Y-%m-%d %H:%M:%S')"
    timer_elapsed="$(_get_timer_hours)"
    [ -z "$TRK_UNFRIENDLY" ] && timer_elapsed="$(_get_friendly_time_from_hours "$timer_elapsed")"
    timer_description="$(cat "$trk_timer_file" | cut -d' ' -f2-)"
    echo "timer_start: $timer_start_date"
    echo "timer_descr: $timer_description"
    echo "timer_elaps: $timer_elapsed"
}
report_records() {
    input_trkfile="$1"
    tags_pattern='#[0-9a-zA-Z_:\-]\{1,\}\b'
    _dbg "tags_pattern: $tags_pattern"
    tags="$(cat "$input_trkfile" | grep -o "$tags_pattern" | sort | uniq)"
    _dbg "$tags_spent"
    tmpfile_tags="$(_mktemp)"; trap "rm -f $tmpfile_tags" EXIT
    total_hours_sum="0"
    while IFS='\n' read c; do
        record_tags="$(echo "$c" | grep -o "$tags_pattern" | sort | uniq)"
        record_date="$(echo "$c" | cut -d' ' -f1)"
        record_hours="$(echo "$c" | cut -d' ' -f2)"
        record_desc="$(echo "$c" | cut -d' ' -f3-)"
        total_hours_sum="${total_hours_sum}+${record_hours}"
        for t in $record_tags; do echo "$t $record_hours" >>"$tmpfile_tags"; done
    done <"$input_trkfile"
    for t in $tags; do
        tag_spent_sum_string="$(grep "^$t\b" "$tmpfile_tags" | cut -d' ' -f2 | paste -sd+)"
        tag_spent="$(awk "BEGIN { print $tag_spent_sum_string }")"
        [ -z "$TRK_UNFRIENDLY" ] && tag_spent="$(_get_friendly_time_from_hours "$tag_spent")"
        echo "tag: $t $tag_spent"
    done
    echo
    total_time_spent="$(awk "BEGIN { print $total_hours_sum }")"
    [ -z "$TRK_UNFRIENDLY" ] && total_time_spent="$(_get_friendly_time_from_hours "$total_time_spent")"
    echo "tot_spent: $total_time_spent"
}
report() {
    report_timer
    [ -z "$1" ] && [ -t 0 ] && return 0
    tmpfile_report="$(_mktemp)"; trap "rm -f $tmpfile_report" EXIT
    [ -z "$1" ] && [ ! -t 0 ] && cat >"$tmpfile_report" && _info "building report from stdin"
    [ -n "$1" ] && [ -t 0 ] && cat $trkfile | grep "$1" >"$tmpfile_report" && _info "building report for trkfile $trkfile"
    echo
    report_records "$tmpfile_report"
}
main() {
    cmd="$1"; shift
    case $cmd in
        t) start_stop_timer "$@";;
        tt) start_stop_timer_notification "$@";;
        a) add_record "$@";;
        r) report "$@";;
        e) edit_trkfile;;
        c) [ -f "$trkfile" ] && cat "$trkfile" | grep -v '^#';;
        h) helpmsg && exit 0;;
        *) if command -v $scriptname-"$cmd">/dev/null; then $scriptname-"$cmd" "$@"; else usage; exit 0; fi;
    esac
}
scriptname=$(basename $0)
[ "$1" ] || { usage; exit 0; } && main "$@"
